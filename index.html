<!DOCTYPE html>
<html>
<head>
    <title>Dylan's Sock Quest: Turbo Edition</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body {
            background-color: #111;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            font-family: 'Verdana', sans-serif;
            overflow: hidden;
            flex-direction: column;
            color: white;
            touch-action: none; 
        }
        
        /* The Game Box - Keeps Aspect Ratio */
        #gameContainer {
            position: relative;
            box-shadow: 0 0 20px rgba(138, 43, 226, 0.5);
            border: 4px solid #8A2BE2;
            border-radius: 12px;
            overflow: hidden;
            background-color: #000;
            /* Dimensions are set by JS to prevent warping */
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }
        
        /* UI Overlays */
        #startScreen, #endScreenControls {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(17, 17, 17, 0.95);
            z-index: 20;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
        }

        #endScreenControls { 
            display: none; 
            pointer-events: none; 
            justify-content: flex-end; 
            padding-bottom: 90px; /* Space for controls */
            background: transparent; 
        }
        
        #endScreenControls button { 
            pointer-events: auto; 
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
        }

        /* Typography */
        h1 { 
            margin: 0 0 10px 0; font-size: 30px; 
            color: #dcf7e6; 
            text-shadow: 2px 2px 0px #8A2BE2; 
            letter-spacing: 2px; 
            text-transform: uppercase;
        }
        /* Make text bigger on big screens */
        @media (min-width: 600px) { h1 { font-size: 50px; } }

        h2 { font-size: 18px; color: #8A2BE2; margin: 0 0 20px 0; }
        p { font-size: 16px; color: #fff; margin: 5px 0; }
        
        button {
            padding: 15px 40px;
            font-size: 20px;
            background-color: #8A2BE2; 
            color: white;
            border: 3px solid #fff;
            border-radius: 30px;
            cursor: pointer; 
            font-weight: bold;
            margin-top: 20px;
            font-family: 'Verdana', sans-serif;
            transition: transform 0.1s;
        }
        button:active { transform: scale(0.95); }

        /* --- MOBILE CONTROLS --- */
        #mobileControls {
            position: absolute;
            bottom: 15px;
            right: 15px;
            z-index: 50;
            display: flex;
            flex-direction: column;
            align-items: center;
            opacity: 0.8;
            user-select: none;
            -webkit-user-select: none;
        }

        .control-row { display: flex; gap: 10px; }
        
        .d-btn {
            width: 55px; height: 55px;
            background: rgba(138, 43, 226, 0.4); 
            border: 2px solid white;
            border-radius: 50%;
            color: white;
            font-size: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            touch-action: manipulation; /* Improves touch response */
            margin: 5px;
            font-weight: bold;
        }
        .d-btn:active { background: rgba(138, 43, 226, 0.9); transform: scale(0.95); }

        /* Status Text */
        #statusMsg { 
            position: absolute; bottom: 20px; width: 100%; 
            text-align: center; font-size: 20px; 
            font-weight: bold; color: white; 
            text-shadow: -2px -2px 0 #000, 2px -2px 0 #000;
            pointer-events: none; z-index: 15;
        }
        #inGameUI {
            position: absolute; top: 10px; left: 10px;
            color: white; font-size: 18px; font-weight: bold; pointer-events: none;
            text-shadow: -1px -1px 0 #000, 1px -1px 0 #000;
        }

    </style>
</head>
<body>

<div id="gameContainer">
    <canvas id="gameCanvas" width="800" height="600"></canvas>
    
    <div id="inGameUI" style="display:none;">Socks: <span id="scoreSpan">0</span> / 15</div>
    <div id="statusMsg" style="display:none;"></div>

    <div id="mobileControls" style="display:none;">
        <div class="d-btn" id="btnUp">↑</div>
        <div class="control-row">
            <div class="d-btn" id="btnLeft">←</div>
            <div class="d-btn" id="btnDown">↓</div>
            <div class="d-btn" id="btnRight">→</div>
        </div>
    </div>

    <div id="startScreen">
        <h1>DYLAN'S SOCK QUEST</h1>
        <h2>Mobile Turbo Edition</h2>
        <p>Collect 15 socks to unlock the door.</p>
        <p>Run to the garden before Melissa arrives!</p>
        <p style="color:#dcf7e6; margin-top:10px; font-size: 14px;"><strong>TIP:</strong> Hold direction for 2s to SPRINT!</p>
        <button onclick="startGame()">START GAME</button>
    </div>

    <div id="endScreenControls">
        <button onclick="resetGame()">TRY AGAIN</button>
    </div>
</div>

<script>
    const container = document.getElementById('gameContainer');
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const startScreen = document.getElementById('startScreen');
    const endScreenControls = document.getElementById('endScreenControls');
    const inGameUI = document.getElementById('inGameUI');
    const statusMsg = document.getElementById('statusMsg');
    const scoreSpan = document.getElementById('scoreSpan');
    const mobileControls = document.getElementById('mobileControls');

    // --- Screen Resizing Logic (Fixes Warping) ---
    function resizeGame() {
        const targetRatio = 800 / 600; // 4:3 Aspect Ratio
        const windowRatio = window.innerWidth / window.innerHeight;
        
        let finalWidth, finalHeight;

        if (windowRatio > targetRatio) {
            // Screen is wider than game -> Fit by height
            finalHeight = window.innerHeight * 0.95; 
            finalWidth = finalHeight * targetRatio;
        } else {
            // Screen is taller than game -> Fit by width
            finalWidth = window.innerWidth * 0.95;
            finalHeight = finalWidth / targetRatio;
        }

        container.style.width = `${finalWidth}px`;
        container.style.height = `${finalHeight}px`;
    }
    
    window.addEventListener('resize', resizeGame);
    resizeGame(); // Call immediately

    // --- Game Variables ---
    let frame = 0;
    let gameState = 'START'; 
    let socksCollected = 0;
    const socksNeeded = 15; 
    let startTime;
    const headStartDuration = 3000; 
    
    // Turbo Boost Variables
    let moveStartTime = 0; 
    let isSprinting = false;

    // --- Objects ---
    let dylan = { x: 400, y: 400, w: 60, h: 40, baseSpeed: 6, speed: 6, dirX: 1, isMoving: false };
    let melissa = { x: -100, y: 400, w: 50, h: 110, speed: 3.5, dirX: 1 };
    const door = { x: 350, y: 60, w: 100, h: 120 }; 
    let socks = [];

    // --- Input Handling ---
    const keys = {};
    
    window.addEventListener('keydown', e => {
        if (!keys[e.key]) moveStartTime = Date.now(); // Start timer on fresh press
        keys[e.key] = true;
    });
    
    window.addEventListener('keyup', e => {
        keys[e.key] = false;
        // If no keys pressed, reset turbo timer
        if (!keys['ArrowUp'] && !keys['ArrowDown'] && !keys['ArrowLeft'] && !keys['ArrowRight']) {
            moveStartTime = 0;
            isSprinting = false;
        }
    });

    // Touch Button Logic
    function setupTouchButton(id, keyName) {
        const btn = document.getElementById(id);
        
        const press = (e) => { 
            e.preventDefault(); 
            if (!keys[keyName]) moveStartTime = Date.now();
            keys[keyName] = true; 
        };
        const release = (e) => { 
            e.preventDefault(); 
            keys[keyName] = false;
            // Check if ANY other button is held, if not reset timer
            setTimeout(() => {
                if(!keys['ArrowUp'] && !keys['ArrowDown'] && !keys['ArrowLeft'] && !keys['ArrowRight']) {
                    moveStartTime = 0;
                    isSprinting = false;
                }
            }, 10);
        };
        
        btn.addEventListener('touchstart', press);
        btn.addEventListener('touchend', release);
        btn.addEventListener('mousedown', press);
        btn.addEventListener('mouseup', release);
        btn.addEventListener('mouseleave', release);
    }

    setupTouchButton('btnUp', 'ArrowUp');
    setupTouchButton('btnDown', 'ArrowDown');
    setupTouchButton('btnLeft', 'ArrowLeft');
    setupTouchButton('btnRight', 'ArrowRight');

    // --- Core Functions ---
    function startGame() {
        startScreen.style.display = 'none';
        inGameUI.style.display = 'block';
        statusMsg.style.display = 'block';
        mobileControls.style.display = 'flex'; // Show Arrows
        resetGame();
        loop();
    }

    function resetGame() {
        gameState = 'PLAYING';
        endScreenControls.style.display = 'none';
        mobileControls.style.display = 'flex'; // ENSURE ARROWS COME BACK
        
        socksCollected = 0;
        scoreSpan.innerText = 0;
        frame = 0;
        startTime = Date.now();
        moveStartTime = 0; // Reset turbo
        
        dylan.x = 400; dylan.y = 400;
        melissa.x = -150; melissa.y = 400;
        statusMsg.innerText = "";
        
        socks = [];
        for(let i=0; i<socksNeeded; i++) {
            socks.push({
                x: Math.random() * 700 + 50,
                y: Math.random() * 300 + 200, 
                color1: `hsl(${Math.random()*360}, 70%, 60%)`, 
                color2: `hsl(${Math.random()*360}, 70%, 40%)`
            });
        }
    }

    // --- Drawing ---
    function drawEnvironment() {
        // Wall (Mint)
        ctx.fillStyle = "#dcf7e6"; ctx.fillRect(0,0, canvas.width, 200);
        // Floor (Wood)
        let floorGrad = ctx.createLinearGradient(0, 200, 0, 600);
        floorGrad.addColorStop(0, "#d2b48c"); floorGrad.addColorStop(1, "#8b4513"); 
        ctx.fillStyle = floorGrad; ctx.fillRect(0, 200, canvas.width, 400);
        
        // Floorboards
        ctx.strokeStyle = "rgba(0,0,0,0.1)"; ctx.lineWidth = 2;
        for(let i=0; i<canvas.width; i+= 80) {
            ctx.beginPath(); ctx.moveTo(i, 200); ctx.lineTo(i-150, 600); ctx.stroke();
        }

        // Door
        ctx.fillStyle = (socksCollected >= socksNeeded) ? "#fff" : "#333"; 
        ctx.fillRect(door.x, door.y, door.w, door.h);
        ctx.strokeStyle = "#4a3020"; ctx.lineWidth = 6;
        ctx.strokeRect(door.x-3, door.y-3, door.w+6, door.h+6);
        ctx.fillStyle = "#111"; ctx.fillRect(door.x+10, door.y+70, door.w-20, 50);
        
        // Door Label
        ctx.font = "bold 16px Verdana"; ctx.textAlign = "center"; ctx.fillStyle = "white"; 
        ctx.strokeStyle = "black"; ctx.lineWidth = 3; ctx.strokeText("DOGGY DOOR", door.x + door.w/2, door.y - 15);
        ctx.fillText("DOGGY DOOR", door.x + door.w/2, door.y
