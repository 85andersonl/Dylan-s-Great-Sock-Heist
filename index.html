<!DOCTYPE html>
<html>
<head>
    <title>Dylan's Great Sock Heist</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        html, body {
            background-color: #000000; /* Pure black to blend with bezels */
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden; /* Prevents scroll bars */
            position: fixed; /* Locks the screen in place */
            inset: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Fredoka', sans-serif;
            color: white;
            touch-action: none; 
        }
        
        /* THE GAME WRAPPER - This scales everything inside it */
        #gameWrapper {
            position: relative;
            width: 800px;
            height: 600px;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
            background-color: #000;
            overflow: hidden;
            transform-origin: center center; /* Scale from center */
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }
        
        /* --- UI Overlays --- */
        #startScreen, #endScreenControls {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 20;
            overflow: hidden;
        }

        /* --- START SCREEN --- */
        #startScreen {
            background-image: url('cover.jpg'); 
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-color: #6a4c93; 
            display: block; 
        }

        /* --- BUTTON STYLES --- */
        
        /* 1. Purple Button (Start & Lose Screen) */
        .purple-btn {
            padding: 16px 60px;
            font-size: 26px;
            background: linear-gradient(135deg, #b06ab3 0%, #450b5a 100%);
            color: white;
            border: 2px solid rgba(255,255,255,0.4);
            border-radius: 50px; 
            cursor: pointer; 
            font-weight: 600;
            box-shadow: 0 8px 20px rgba(75, 0, 130, 0.4);
            transition: transform 0.1s;
            pointer-events: auto;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: absolute;
            left: 50%;
            bottom: 28%; /* Locked position relative to 800x600 canvas */
            transform: translateX(-50%);
            white-space: nowrap;
        }
        .purple-btn:active { transform: translateX(-50%) scale(0.95); }

        /* 2. White "Get More Socks" Button (Win Screen Only) */
        .win-btn {
            padding: 12px 35px;
            font-size: 20px;    
            background: white;
            color: black;
            border: 3px solid #111;
            border-radius: 15px; 
            cursor: pointer; 
            font-weight: 800;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            transition: transform 0.1s;
            pointer-events: auto;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: absolute;
            left: 50%;
            bottom: 15%; 
            transform: translateX(-50%);
            white-space: nowrap;
        }
        .win-btn:active { transform: translateX(-50%) scale(0.95); }


        /* --- END SCREEN --- */
        #endScreenControls { 
            display: none; 
            pointer-events: none;
        }
        #endScreenControls > * { pointer-events: auto; }

        /* --- Mobile Controls --- */
        #mobileControls {
            position: absolute;
            bottom: 30px; /* Moved up slightly to avoid being cut off */
            right: 30px;  /* Moved in slightly */
            z-index: 50;
            display: flex;
            flex-direction: column;
            align-items: center;
            opacity: 0.7;
        }

        .control-row { display: flex; gap: 10px; }
        .d-btn {
            width: 70px; height: 70px; /* Base size, will scale down on phone */
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(5px);
            border: 2px solid rgba(255,255,255,0.4);
            border-radius: 50%;
            color: white;
            font-size: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            touch-action: manipulation;
            margin: 5px;
            user-select: none;
            pointer-events: auto;
        }
        .d-btn:active { background: rgba(255, 255, 255, 0.4); transform: scale(0.95); }

        /* Game HUD */
        #statusMsg { 
            position: absolute; bottom: 30px; width: 100%; 
            text-align: center; font-size: 24px; 
            font-weight: 600; color: white; 
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
            pointer-events: none; z-index: 15;
        }
        #inGameUI {
            position: absolute; top: 20px; left: 20px;
            color: white; font-size: 24px; font-weight: 600; pointer-events: none;
            background: rgba(0,0,0,0.3);
            padding: 10px 20px;
            border-radius: 30px;
            backdrop-filter: blur(4px);
        }
        
        /* Sprint Bar */
        #sprintBarContainer {
            position: absolute; 
            top: 85px; 
            left: 20px;
            width: 150px; height: 12px;
            background: rgba(255,255,255,0.3);
            border-radius: 10px;
            border: 2px solid white;
            display: none;
            z-index: 15;
        }
        #sprintBarFill {
            width: 0%; height: 100%;
            background: #32CD32; 
            border-radius: 8px;
            transition: width 0.1s;
        }
        #sprintLabel {
            position: absolute; top: -25px; left: 5px;
            font-size: 16px; 
            color: black; 
            font-weight: 800;
            text-shadow: 1px 1px 0px white; 
            letter-spacing: 1px;
        }
    </style>
</head>
<body>

<div id="gameWrapper">
    <canvas id="gameCanvas" width="800" height="600"></canvas>
    
    <div id="inGameUI" style="display:none;">Socks: <span id="scoreSpan">0</span> / 15</div>
    
    <div id="sprintBarContainer">
        <div id="sprintLabel">SPRINT</div>
        <div id="sprintBarFill"></div>
    </div>

    <div id="statusMsg" style="display:none;"></div>

    <div id="mobileControls" style="display:none;">
        <div class="d-btn" id="btnUp">↑</div>
        <div class="control-row">
            <div class="d-btn" id="btnLeft">←</div>
            <div class="d-btn" id="btnDown">↓</div>
            <div class="d-btn" id="btnRight">→</div>
        </div>
    </div>

    <div id="startScreen">
        <button id="startBtn" class="purple-btn">START GAME</button>
    </div>

    <div id="endScreenControls">
        <button id="tryAgainBtn" class="purple-btn">TRY AGAIN</button>
    </div>
</div>

<script>
window.onload = function() {
    const wrapper = document.getElementById('gameWrapper');
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const startScreen = document.getElementById('startScreen');
    const endScreenControls = document.getElementById('endScreenControls');
    const tryAgainBtn = document.getElementById('tryAgainBtn');
    const inGameUI = document.getElementById('inGameUI');
    const statusMsg = document.getElementById('statusMsg');
    const scoreSpan = document.getElementById('scoreSpan');
    const mobileControls = document.getElementById('mobileControls');
    const sprintBarContainer = document.getElementById('sprintBarContainer');
    const sprintBarFill = document.getElementById('sprintBarFill');
    
    // Load Images
    const caughtImg = new Image(); caughtImg.src = 'caught.jpg';

    document.getElementById('startBtn').onclick = startGame;
    tryAgainBtn.onclick = resetGame;

    // --- NEW SCALING LOGIC ---
    // This scales the entire game wrapper like an image
    function resizeGame() {
        const width = window.innerWidth;
        const height = window.innerHeight;
        const gameWidth = 800;
        const gameHeight = 600;
        
        // Calculate scale
        const scale = Math.min(width / gameWidth, height / gameHeight);
        
        // Apply scale to wrapper
        wrapper.style.transform = `scale(${scale})`;
        
        // Center alignment fix for some browsers
        // (The flex body handles centering, this just ensures size)
    }
    window.addEventListener('resize', resizeGame);
    resizeGame(); 

    let frame = 0;
    let gameState = 'START'; 
    let socksCollected = 0;
    const socksNeeded = 15; 
    let startTime;
    const headStartDuration = 3000; 
    let moveStartTime = 0; 
    let isSprinting = false;
    let winStartTime = 0;

    let dylan = { x: 400, y: 400, w: 80, h: 55, baseSpeed: 5, speed: 5, dirX: 1, isMoving: false };
    let melissa = { x: -100, y: 400, w: 50, h: 110, speed: 3.2, dirX: 1 };
    const door = { x: 350, y: 60, w: 100, h: 120 }; 
    let socks = [];

    const keys = {};
    window.addEventListener('keydown', e => {
        if (!keys[e.key]) moveStartTime = Date.now();
        keys[e.key] = true;
    });
    window.addEventListener('keyup', e => {
        keys[e.key] = false;
        checkSprintReset();
    });

    function checkSprintReset() {
        if (!keys['ArrowUp'] && !keys['ArrowDown'] && !keys['ArrowLeft'] && !keys['ArrowRight']) {
            moveStartTime = 0; 
            isSprinting = false;
            sprintBarFill.style.width = "0%";
        }
    }

    function setupTouchButton(id, keyName) {
        const btn = document.getElementById(id);
        const press = (e) => { 
            e.preventDefault(); 
            if (!keys[keyName]) moveStartTime = Date.now();
            keys[keyName] = true; 
        };
        const release = (e) => { 
            e.preventDefault(); 
            keys[keyName] = false;
            setTimeout(checkSprintReset, 20);
        };
        btn.addEventListener('touchstart', press);
        btn.addEventListener('touchend', release);
        btn.addEventListener('mousedown', press);
        btn.addEventListener('mouseup', release);
        btn.addEventListener('mouseleave', release);
    }
    setupTouchButton('btnUp', 'ArrowUp');
    setupTouchButton('btnDown', 'ArrowDown');
    setupTouchButton('btnLeft', 'ArrowLeft');
    setupTouchButton('btnRight', 'ArrowRight');

    function startGame() {
        startScreen.style.display = 'none';
        inGameUI.style.display = 'block';
        statusMsg.style.display = 'block';
        mobileControls.style.display = 'flex'; 
        sprintBarContainer.style.display = 'block';
        resetGame();
        loop();
    }

    function resetGame() {
        gameState = 'PLAYING';
        endScreenControls.style.display = 'none';
        mobileControls.style.display = 'flex'; 
        sprintBarContainer.style.display = 'block';
        
        socksCollected = 0;
        scoreSpan.innerText = 0;
        frame = 0;
        startTime = Date.now();
        moveStartTime = 0; 
        sprintBarFill.style.width = "0%";
        winStartTime = 0;
        
        dylan.x = 400; dylan.y = 400;
        melissa.x = -150; melissa.y = 400;
        statusMsg.innerText = "";
        
        socks = [];
        for(let i=0; i<socksNeeded; i++) {
            socks.push({
                x: Math.random() * 700 + 50,
                y: Math.random() * 300 + 200, 
                color1: `hsl(${Math.random()*360}, 70%, 60%)`, 
                color2: `hsl(${Math.random()*360}, 70%, 40%)`
            });
        }
    }

    function drawEnvironment() {
        ctx.fillStyle = "#e0f2f1"; ctx.fillRect(0,0, canvas.width, 200);
        let floorGrad = ctx.createLinearGradient(0, 200, 0, 600);
        floorGrad.addColorStop(0, "#d7ccc8"); floorGrad.addColorStop(1, "#8d6e63"); 
        ctx.fillStyle = floorGrad; ctx.fillRect(0, 200, canvas.width, 400);
        ctx.strokeStyle = "rgba(0,0,0,0.05)"; ctx.lineWidth = 2;
        for(let i=0; i<canvas.width; i+= 80) {
            ctx.beginPath(); ctx.moveTo(i, 200); ctx.lineTo(i-150, 600); ctx.stroke();
        }
        ctx.fillStyle = (socksCollected >= socksNeeded) ? "#fff" : "#4e342e"; 
        ctx.fillRect(door.x, door.y, door.w, door.h);
        ctx.strokeStyle = "#3e2723"; ctx.lineWidth = 6;
        ctx.strokeRect(door.x-3, door.y-3, door.w+6, door.h+6);
        ctx.fillStyle = "#212121"; ctx.fillRect(door.x+10, door.y+70, door.w-20, 50);
        ctx.font = "bold 16px Fredoka"; ctx.textAlign = "center"; ctx.fillStyle = "#3e2723"; 
        ctx.fillText("DOGGY DOOR", door.x + door.w/2, door.y - 10);
    }

    function drawRealSock(x, y, c1, c2, scale=1) {
        ctx.save(); ctx.translate(x, y); ctx.scale(scale, scale);
        ctx.fillStyle = c1; ctx.beginPath();
        ctx.moveTo(0, 0); ctx.lineTo(0, 20); ctx.bezierCurveTo(0, 30, 10, 30, 15, 25); 
        ctx.lineTo(25, 25); ctx.bezierCurveTo(30, 25, 30, 15, 25, 15); 
        ctx.lineTo(10, 15); ctx.lineTo(10, 0); ctx.fill();
        ctx.fillStyle = c2; ctx.beginPath();
        ctx.moveTo(25, 15); ctx.bezierCurveTo(30, 15, 30, 25, 25, 25);
        ctx.lineTo(20, 25); ctx.lineTo(20, 15); ctx.fill();
        ctx.fillStyle = c2; ctx.fillRect(0, 0, 10, 5);
        ctx.restore();
    }

    function drawDylan(x, y, dir, hasSocks, scale=1) {
        ctx.save(); ctx.translate(x + dylan.w/2, y + dylan.h/2); ctx.scale(scale, scale);
        if (dir === -1) ctx.scale(-1, 1);

        if (isSprinting && gameState === 'PLAYING') {
            ctx.fillStyle = `hsl(${frame * 20}, 100%, 70%)`; 
            for(let i=0; i<3; i++) {
                let sx = -50 - Math.random() * 20; let sy = Math.random() * 30 - 10;
                ctx.beginPath(); ctx.arc(sx, sy, 4, 0, Math.PI*2); ctx.fill();
            }
        }

        let moveBounce = dylan.isMoving ? Math.sin(frame * (isSprinting ? 0.8 : 0.4)) * 3 : 0;
        let legMove = dylan.isMoving ? Math.sin(frame * (isSprinting ? 0.8 : 0.4)) * 10 : 0;

        ctx.fillStyle = "#111"; 
        ctx.fillRect(-25 + legMove, 20, 12, 30); ctx.fillRect(15 - legMove, 20, 12, 30); 
        ctx.fillRect(-35 - legMove, 25, 12, 30); ctx.fillRect(20 + legMove, 25, 12, 30); 
        ctx.fillStyle = "white"; 
        ctx.fillRect(-25 + legMove, 45, 12, 5); ctx.fillRect(15 - legMove, 45, 12, 5);
        ctx.fillRect(-35 - legMove, 50, 12, 5); ctx.fillRect(20 + legMove, 50, 12, 5);

        let tailWag = Math.sin(frame * (isSprinting ? 1.0 : 0.5)) * 20;
        ctx.strokeStyle = "#111"; ctx.lineWidth = 14; ctx.lineCap = "round";
        ctx.beginPath(); ctx.moveTo(-35, 5); ctx.quadraticCurveTo(-60, -10 + tailWag, -75, 5 + tailWag); ctx.stroke();
        ctx.strokeStyle = "white"; ctx.lineWidth = 10; 
        ctx.beginPath(); ctx.moveTo(-70, 0 + tailWag); ctx.lineTo(-76, 5 + tailWag); ctx.stroke();

        ctx.fillStyle = "#111"; ctx.beginPath(); ctx.ellipse(0, 5 + moveBounce, 45, 30, 0, 0, Math.PI * 2); ctx.fill();
        ctx.fillStyle = "white"; ctx.beginPath(); 
        ctx.moveTo(-10, 10 + moveBounce); ctx.lineTo(30, 10 + moveBounce); 
        ctx.lineTo(25, 38 + moveBounce); ctx.lineTo(-5, 38 + moveBounce); ctx.fill();

        ctx.fillStyle = "#111"; ctx.beginPath(); ctx.arc(35, -15 + moveBounce, 24, 0, Math.PI * 2); ctx.fill();
        ctx.beginPath(); ctx.ellipse(28, -25 + moveBounce, 10, 18, -0.5, 0, Math.PI * 2); ctx.fill(); 
        ctx.fillStyle = "white"; 
        ctx.beginPath(); ctx.ellipse(35, -15 + moveBounce, 6, 18, 0, 0, Math.PI * 2); ctx.fill(); 
        ctx.beginPath(); ctx.ellipse(38, -8 + moveBounce, 12, 10, 0, 0, Math.PI * 2); ctx.fill(); 
        ctx.fillStyle = "black"; ctx.beginPath(); ctx.arc(42, -12 + moveBounce, 3, 0, Math.PI * 2); ctx.fill(); 
        ctx.fillStyle = "white"; ctx.beginPath(); ctx.arc(36, -20 + moveBounce, 3, 0, Math.PI * 2); ctx.fill(); 
        ctx.fillStyle = "black"; ctx.beginPath(); ctx.arc(37, -20 + moveBounce, 1.5, 0, Math.PI * 2); ctx.fill(); 

        if (hasSocks) { drawRealSock(45, -8 + moveBounce, socks[0] ? socks[0].color1 : "#FF69B4", "white", 0.6); } 
        else { ctx.fillStyle = "#ff8a80"; ctx.beginPath(); ctx.ellipse(42, -5+moveBounce, 5, 8, 0.5, 0, Math.PI*2); ctx.fill(); }
        ctx.restore();
    }

    function drawMelissa(x, y, dir, isAngry, scale=1) {
        ctx.save(); ctx.translate(x + melissa.w/2, y + melissa.h/2); ctx.scale(scale, scale);
        if (dir === -1) ctx.scale(-1, 1);

        let sway = isAngry ? 0 : Math.sin(frame * 0.1) * 2;
        let hairFlow = isAngry ? 0 : Math.sin(frame * 0.15) * 5;

        ctx.fillStyle = "#8A2BE2"; ctx.beginPath(); ctx.moveTo(0, -50); ctx.bezierCurveTo(-50, -20, -60 + hairFlow, 20, -40 + hairFlow, 60); ctx.lineTo(15, -30); ctx.fill();
        ctx.fillStyle = "#111"; ctx.beginPath(); ctx.moveTo(0, -50); ctx.bezierCurveTo(-45, -20, -55 + hairFlow, 10, -35 + hairFlow, 50); ctx.lineTo(15, -30); ctx.fill();
        ctx.fillStyle = "#740001"; ctx.beginPath(); ctx.moveTo(5, -30); ctx.lineTo(-30, 55); ctx.lineTo(30, 55); ctx.lineTo(15, -30); ctx.fill();
        ctx.fillStyle = "#1a1a1a"; ctx.beginPath(); ctx.moveTo(5, -30); ctx.lineTo(-20, 55); ctx.lineTo(20, 55); ctx.lineTo(15, -30); ctx.fill();
        ctx.fillStyle = "#740001"; ctx.fillRect(-15, -25, 6, 80); ctx.fillRect(15, -25, 6, 80);
        ctx.fillStyle = "#e0ac69"; ctx.beginPath(); ctx.arc(5, -35 + sway, 13, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = "black"; ctx.beginPath(); ctx.arc(10, -35 + sway, 2, 0, Math.PI*2); ctx.fill(); 
        ctx.save(); ctx.translate(2, -45 + sway); ctx.rotate(-0.1);
        ctx.fillStyle = "#111"; ctx.beginPath(); ctx.ellipse(0, 0, 28, 6, 0, 0, Math.PI*2); ctx.fill(); 
        ctx.beginPath(); ctx.moveTo(-18, 0); ctx.lineTo(0, -50); ctx.lineTo(18, 0); ctx.fill(); 
        ctx.fillStyle = "#740001"; ctx.fillRect(-14, -8, 28, 5); 
        ctx.restore();

        if (isAngry) {
            ctx.strokeStyle = "#e0ac69"; ctx.lineWidth = 4;
            ctx.beginPath(); ctx.moveTo(0, -10); ctx.lineTo(-15, 10); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(10, -10); ctx.lineTo(25, 10); ctx.stroke();
        } else {
            ctx.strokeStyle = "#e0ac69"; ctx.lineWidth = 4;
            ctx.beginPath(); ctx.moveTo(10, -10); ctx.lineTo(25, 0); ctx.stroke();
            ctx.strokeStyle = "#5d4037"; ctx.lineWidth = 3;
            ctx.beginPath(); ctx.moveTo(25, 0); ctx.lineTo(45, -5); ctx.stroke();
            ctx.fillStyle = "#00ffff"; ctx.beginPath(); ctx.arc(45, -5, Math.random()*4+2, 0, Math.PI*2); ctx.fill();
        }
        ctx.restore();
    }

    function update() {
        if (gameState !== 'PLAYING') return;
        frame++;

        let elapsed = Date.now() - startTime;
        let remainingHeadStart = Math.ceil((headStartDuration - elapsed) / 1000);

        if (remainingHeadStart > 0) {
            statusMsg.innerText = `Melissa enters in: ${remainingHeadStart}`;
            statusMsg.style.color = "white";
        } else if (remainingHeadStart <= 0 && melissa.x < -50) {
             statusMsg.innerText = "MELISSA IS HERE! RUN!"; statusMsg.style.color = "#FF1493"; 
        } else if (socksCollected < socksNeeded && statusMsg.innerText !== "Collect all socks first!") {
             statusMsg.innerText = ""; 
        }

        dylan.isMoving = false;
        let currentSpeed = dylan.baseSpeed;
        
        if (moveStartTime > 0) {
            let duration = Date.now() - moveStartTime;
            let charge = Math.min(100, (duration / 2000) * 100);
            sprintBarFill.style.width = charge + "%";
            
            if (duration > 2000) {
                currentSpeed = 10; 
                isSprinting = true;
                sprintBarFill.style.background = "#00FF00"; 
            } else {
                isSprinting = false;
                sprintBarFill.style.background = "#32CD32"; 
            }
        }

        if (keys['ArrowUp'] && dylan.y > 150) { dylan.y -= currentSpeed; dylan.isMoving = true; }
        if (keys['ArrowDown'] && dylan.y + dylan.h < 600) { dylan.y += currentSpeed; dylan.isMoving = true; }
        if (keys['ArrowLeft'] && dylan.x > 0) { dylan.x -= currentSpeed; dylan.dirX = -1; dylan.isMoving = true; }
        if (keys['ArrowRight'] && dylan.x + dylan.w < 800) { dylan.x += currentSpeed; dylan.dirX = 1; dylan.isMoving = true; }

        if (dylan.x > door.x - 20 && dylan.x < door.x + door.w + 20 && dylan.y < 230) {
             if (socksCollected >= socksNeeded) {
                 gameState = 'WON'; endGame();
             } else {
                 statusMsg.innerText = "Collect all socks first!";
                 statusMsg.style.color = "white";
             }
        }

        if (remainingHeadStart <= 0) {
            let dx = dylan.x - melissa.x;
            let dy = dylan.y - melissa.y;
            let dist = Math.sqrt(dx*dx + dy*dy);
            if (dist > 10) {
                melissa.x += (dx/dist) * melissa.speed;
                melissa.y += (dy/dist) * melissa.speed;
                melissa.dirX = dx > 0 ? 1 : -1;
            }
            if (dist < 40) { gameState = 'LOST'; endGame(); }
        }

        for (let i = socks.length - 1; i >= 0; i--) {
            let s = socks[i];
            if (dylan.x < s.x + 30 && dylan.x + dylan.w > s.x && 
                dylan.y < s.y + 30 && dylan.y + dylan.h > s.y) {
                socks.splice(i, 1);
                socksCollected++;
                scoreSpan.innerText = socksCollected;
                if (socksCollected >= socksNeeded) {
                    statusMsg.innerText = "RUN TO THE DOGGY DOOR!";
                    statusMsg.style.color = "#00FF00";
                }
            }
        }
    }

    function endGame() {
        endScreenControls.style.display = 'flex'; 
        mobileControls.style.display = 'none'; 
        sprintBarContainer.style.display = 'none';
        statusMsg.innerText = "";
        
        if (gameState === 'WON') {
            winStartTime = Date.now();
            tryAgainBtn.className = 'win-btn';
            tryAgainBtn.innerText = 'GET MORE SOCKS';
        } else {
            tryAgainBtn.className = 'purple-btn';
            tryAgainBtn.innerText = 'TRY AGAIN';
        }
    }

    function draw() {
        if(gameState === 'START') return;
        ctx.clearRect(0,0, canvas.width, canvas.height);
        if (gameState === 'WON') { drawWinScene(); return; }
        if (gameState === 'LOST') { drawLoseScene(); return; }

        drawEnvironment();
        socks.forEach(s => drawRealSock(s.x, s.y, s.color1, s.color2));
        drawDylan(dylan.x, dylan.y, dylan.dirX, socksCollected > 0);
        
        let elapsed = Date.now() - startTime;
        if (elapsed > headStartDuration || melissa.x > -100) {
             drawMelissa(melissa.x, melissa.y, melissa.dirX, false);
        }
    }

    function drawTree(x, y, scale=1) {
        ctx.save(); ctx.translate(x,y); ctx.scale(scale, scale);
        ctx.fillStyle = "#5d4037"; ctx.fillRect(0, 0, 20, 60);
        ctx.fillStyle = "#388e3c"; 
        ctx.beginPath(); ctx.arc(10, -10, 30, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(-10, 10, 25, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(30, 5, 25, 0, Math.PI*2); ctx.fill();
        ctx.restore();
    }
    function drawFence(x, y) {
        ctx.fillStyle = "#ffffff"; 
        ctx.fillRect(x, y, 15, 50); ctx.fillRect(x+40, y, 15, 50);
        ctx.fillRect(x-10, y+10, 70, 8); ctx.fillRect(x-10, y+30, 70, 8);
    }
    function drawShed(x, y) {
        ctx.fillStyle = "#f5f5f5"; ctx.fillRect(x, y, 100, 80);
        ctx.fillStyle = "#616161"; 
        ctx.beginPath(); ctx.moveTo(x-10, y); ctx.lineTo(x+50, y-40); ctx.lineTo(x+110, y); ctx.fill();
        ctx.strokeStyle = "#bdbdbd"; ctx.lineWidth=2; ctx.strokeRect(x+30, y+20, 40, 60);
        ctx.fillStyle = "#757575"; ctx.beginPath(); ctx.arc(x+65, y+50, 3, 0, Math.PI*2); ctx.fill();
    }

    function drawPig(x, y, dir) {
        ctx.save(); ctx.translate(x, y); if(dir === -1) ctx.scale(-1,1);
        let bounce = Math.sin(frame * 0.2) * 3;
        ctx.fillStyle = "#ffcccb"; 
        ctx.beginPath(); ctx.ellipse(0, 20+bounce, 30, 20, 0, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(25, 15+bounce, 15, 0, Math.PI*2); ctx.fill(); 
        ctx.fillStyle = "#ffb6c1"; ctx.beginPath(); ctx.ellipse(35, 15+bounce, 8, 6, 0, 0, Math.PI*2); ctx.fill(); 
        ctx.fillStyle = "black"; ctx.beginPath(); ctx.arc(28, 12+bounce, 2, 0, Math.PI*2); ctx.fill(); 
        ctx.strokeStyle = "#ffcccb"; ctx.lineWidth=4; ctx.beginPath(); ctx.moveTo(-25, 20+bounce); ctx.quadraticCurveTo(-35, 10+bounce, -30, 25+bounce); ctx.stroke(); 
        
        ctx.fillStyle = "#ffcccb"; 
        let legMove = Math.sin(frame * 0.4) * 8; 
        ctx.fillRect(-15 + legMove, 35+bounce, 8, 15);
        ctx.fillRect(5 - legMove, 35+bounce, 8, 15);
        
        ctx.restore();
    }

    function drawSmallDog(x, y, dir) {
        ctx.save(); ctx.translate(x, y); ctx.scale(0.7, 0.7); if(dir === -1) ctx.scale(-1,1);
        let bounce = Math.sin(frame * 0.3) * 3;
        ctx.fillStyle = "black"; ctx.beginPath(); ctx.ellipse(0, 20+bounce, 30, 18, 0, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = "white"; ctx.fillRect(-5, 25+bounce, 15, 15);
        ctx.fillStyle = "black"; ctx.beginPath(); ctx.arc(25, 15+bounce, 14, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = "white"; ctx.beginPath(); ctx.ellipse(28, 15+bounce, 6, 10, 0, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = "black"; ctx.beginPath(); ctx.arc(30, 13+bounce, 2, 0, Math.PI*2); ctx.fill();
        
        let legMove = Math.sin(frame * 0.6) * 10; 
        ctx.fillRect(-15 + legMove, 35+bounce, 8, 15);
        ctx.fillRect(5 - legMove, 35+bounce, 8, 15);
        
        ctx.restore();
    }

    function drawWinScene() {
        frame++;
        let grad = ctx.createLinearGradient(0, 0, 0, 600);
        grad.addColorStop(0, "#a8c0ff"); grad.addColorStop(1, "#3f2b96"); 
        ctx.fillStyle = grad; ctx.fillRect(0,0, canvas.width, canvas.height);
        
        ctx.fillStyle = "#66bb6a"; ctx.fillRect(0, 300, canvas.width, 300);
        
        for(let i=0; i<canvas.width; i+=60) { drawTree(i-30, 260); }
        for(let i=0; i<canvas.width; i+=60) { drawFence(i, 300); }

        drawShed(50, 350); 
        drawTree(650, 330, 1.5); drawTree(740, 360, 1.4); drawTree(560, 380, 1.3);

        let runX = 400 + Math.sin(frame * 0.05) * 250;
        let runDir = Math.cos(frame * 0.05) > 0 ? 1 : -1;
        dylan.isMoving = true; drawDylan(runX, 400, runDir, true);

        let pigX = 150 + Math.sin(frame * 0.07) * 100;
        drawPig(pigX, 420, Math.cos(frame * 0.07) > 0 ? 1 : -1);

        if (Date.now() - winStartTime > 3000) {
             let dogX = 600 + Math.cos(frame * 0.06) * 150;
             drawSmallDog(dogX, 430, -Math.sin(frame * 0.06) > 0 ? 1 : -1);
        }

        ctx.font = "bold 50px Fredoka"; ctx.textAlign = "center"; 
        
        ctx.strokeStyle = "black"; ctx.lineWidth = 4;
        ctx.strokeText("FREEDOM!", 400, 100);
        ctx.fillStyle = "white"; 
        ctx.fillText("FREEDOM!", 400, 100);
        
        ctx.font = "24px Fredoka"; 
        ctx.fillText("Dylan is free in the garden!", 400, 150);
    }

    function drawLoseScene() {
        if (caughtImg.complete) {
            ctx.drawImage(caughtImg, 0, 0, canvas.width, canvas.height);
        } else {
            let grad = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
            grad.addColorStop(0, "#a8c0ff"); grad.addColorStop(1, "#3f2b96"); 
            ctx.fillStyle = grad; ctx.fillRect(0,0, canvas.width, canvas.height);
            ctx.fillStyle = "white"; ctx.fillText("CAUGHT! (Image not loaded)", 400, 300);
        }
    }

    function loop() {
        update();
        draw();
        if(gameState === 'PLAYING' || gameState === 'WON' || gameState === 'LOST') {
            requestAnimationFrame(loop);
        }
    }
    
    draw();
};
</script>
</body>
</html>
