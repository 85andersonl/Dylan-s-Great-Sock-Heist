<!DOCTYPE html>
<html>
<head>
    <title>Dylan's Great Sock Heist</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body {
            background-color: #1a1a1a;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            font-family: 'Fredoka', sans-serif;
            overflow: hidden;
            color: white;
            touch-action: none; 
        }
        
        #gameContainer {
            position: relative;
            width: 800px; 
            height: 600px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            border-radius: 20px;
            overflow: hidden;
            background-color: #000;
            border: 4px solid rgba(255,255,255,0.1);
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }
        
        /* --- UI Overlays --- */
        #startScreen, #endScreenControls {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 20;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            /* Allow clicks to pass through empty areas */
            pointer-events: none; 
        }
        
        /* Make buttons and text clickable/visible */
        #startScreen > *, #endScreenControls > * { pointer-events: auto; }

        #endScreenControls { 
            display: none; 
            justify-content: flex-end; 
            padding-bottom: 90px;
        }

        /* --- Typography --- */
        h1 { 
            margin: 0 0 15px 0; 
            font-size: 55px; 
            font-weight: 600;
            color: #ffffff; 
            text-shadow: 0px 4px 10px rgba(138, 43, 226, 0.4); 
            letter-spacing: 1px;
            line-height: 1.1;
        }
        
        p { 
            font-size: 20px; 
            color: #f0f0f0; 
            margin: 8px 0; 
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
            font-weight: 400;
        }
        
        .tip {
            margin-top: 20px;
            font-size: 16px;
            color: #e0e0e0;
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 16px;
            border-radius: 20px;
        }

        /* --- Buttons --- */
        button {
            padding: 16px 60px;
            font-size: 24px;
            background: linear-gradient(90deg, #8A2BE2 0%, #008080 100%);
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer; 
            font-weight: 600;
            margin-top: 30px;
            font-family: 'Fredoka', sans-serif;
            box-shadow: 0 5px 20px rgba(138, 43, 226, 0.4);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(138, 43, 226, 0.6);
        }
        button:active { transform: scale(0.98); }

        /* --- Touch Controls --- */
        #mobileControls {
            position: absolute;
            bottom: 20px; right: 20px;
            z-index: 50;
            display: flex;
            flex-direction: column;
            align-items: center;
            opacity: 0.6;
            transition: opacity 0.3s;
        }
        #mobileControls:hover, #mobileControls:active { opacity: 1; }

        .control-row { display: flex; gap: 10px; }
        .d-btn {
            width: 60px; height: 60px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(5px);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            color: white;
            font-size: 28px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            touch-action: manipulation;
            margin: 5px;
            user-select: none;
            pointer-events: auto;
        }
        .d-btn:active { background: rgba(255, 255, 255, 0.3); transform: scale(0.95); }

        /* Game HUD */
        #statusMsg { 
            position: absolute; bottom: 30px; width: 100%; 
            text-align: center; font-size: 24px; 
            font-weight: 600; color: white; 
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            pointer-events: none; z-index: 15;
        }
        #inGameUI {
            position: absolute; top: 20px; left: 20px;
            color: white; font-size: 22px; font-weight: 600; pointer-events: none;
            background: rgba(0,0,0,0.3);
            padding: 8px 16px;
            border-radius: 30px;
            backdrop-filter: blur(4px);
        }
    </style>
</head>
<body>

<div id="gameContainer">
    <canvas id="gameCanvas" width="800" height="600"></canvas>
    
    <div id="inGameUI" style="display:none;">Socks: <span id="scoreSpan">0</span> / 15</div>
    <div id="statusMsg" style="display:none;"></div>

    <div id="mobileControls" style="display:none;">
        <div class="d-btn" id="btnUp">↑</div>
        <div class="control-row">
            <div class="d-btn" id="btnLeft">←</div>
            <div class="d-btn" id="btnDown">↓</div>
            <div class="d-btn" id="btnRight">→</div>
        </div>
    </div>

    <div id="startScreen">
        <h1>DYLAN'S GREAT<br>SOCK HEIST</h1>
        <p>Collect all 15 socks to unlock the door.</p>
        <p>Run to the garden before Melissa arrives!</p>
        <div class="tip"><strong>TIP:</strong> Hold direction for 2s to SPRINT!</div>
        <button id="startBtn">START GAME</button>
    </div>

    <div id="endScreenControls">
        <button id="tryAgainBtn">TRY AGAIN</button>
    </div>
</div>

<script>
window.onload = function() {
    // --- Elements ---
    const container = document.getElementById('gameContainer');
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const startScreen = document.getElementById('startScreen');
    const endScreenControls = document.getElementById('endScreenControls');
    const inGameUI = document.getElementById('inGameUI');
    const statusMsg = document.getElementById('statusMsg');
    const scoreSpan = document.getElementById('scoreSpan');
    const mobileControls = document.getElementById('mobileControls');
    
    document.getElementById('startBtn').onclick = startGame;
    document.getElementById('tryAgainBtn').onclick = resetGame;

    // --- Responsive Resize ---
    function resizeGame() {
        const targetRatio = 800 / 600; 
        const windowRatio = window.innerWidth / window.innerHeight;
        let finalWidth, finalHeight;
        if (windowRatio > targetRatio) {
            finalHeight = window.innerHeight * 0.95; 
            finalWidth = finalHeight * targetRatio;
        } else {
            finalWidth = window.innerWidth * 0.95;
            finalHeight = finalWidth / targetRatio;
        }
        container.style.width = finalWidth + "px";
        container.style.height = finalHeight + "px";
    }
    window.addEventListener('resize', resizeGame);
    resizeGame(); 

    // --- Game Variables ---
    let frame = 0;
    let gameState = 'START'; 
    let socksCollected = 0;
    const socksNeeded = 15; 
    let startTime;
    const headStartDuration = 3000; 
    let moveStartTime = 0; 
    let isSprinting = false;

    // --- Objects ---
    let dylan = { x: 400, y: 400, w: 80, h: 55, baseSpeed: 6, speed: 6, dirX: 1, isMoving: false };
    let melissa = { x: -100, y: 400, w: 50, h: 110, speed: 3.5, dirX: 1 };
    const door = { x: 350, y: 60, w: 100, h: 120 }; 
    let socks = [];

    // --- Inputs ---
    const keys = {};
    window.addEventListener('keydown', e => {
        if (!keys[e.key]) moveStartTime = Date.now();
        keys[e.key] = true;
    });
    window.addEventListener('keyup', e => {
        keys[e.key] = false;
        if (!keys['ArrowUp'] && !keys['ArrowDown'] && !keys['ArrowLeft'] && !keys['ArrowRight']) {
            moveStartTime = 0; isSprinting = false;
        }
    });

    // Touch Controls
    function setupTouchButton(id, keyName) {
        const btn = document.getElementById(id);
        const press = (e) => { 
            e.preventDefault(); 
            if (!keys[keyName]) moveStartTime = Date.now();
            keys[keyName] = true; 
        };
        const release = (e) => { 
            e.preventDefault(); 
            keys[keyName] = false;
            setTimeout(() => {
                if(!keys['ArrowUp'] && !keys['ArrowDown'] && !keys['ArrowLeft'] && !keys['ArrowRight']) {
                    moveStartTime = 0; isSprinting = false;
                }
            }, 10);
        };
        btn.addEventListener('touchstart', press);
        btn.addEventListener('touchend', release);
        btn.addEventListener('mousedown', press);
        btn.addEventListener('mouseup', release);
        btn.addEventListener('mouseleave', release);
    }
    setupTouchButton('btnUp', 'ArrowUp');
    setupTouchButton('btnDown', 'ArrowDown');
    setupTouchButton('btnLeft', 'ArrowLeft');
    setupTouchButton('btnRight', 'ArrowRight');

    // --- Functions ---
    function startGame() {
        startScreen.style.display = 'none';
        inGameUI.style.display = 'block';
        statusMsg.style.display = 'block';
        mobileControls.style.display = 'flex'; 
        resetGame();
        loop();
    }

    function resetGame() {
        gameState = 'PLAYING';
        endScreenControls.style.display = 'none';
        mobileControls.style.display = 'flex'; 
        
        socksCollected = 0;
        scoreSpan.innerText = 0;
        frame = 0;
        startTime = Date.now();
        moveStartTime = 0; 
        
        dylan.x = 400; dylan.y = 400;
        melissa.x = -150; melissa.y = 400;
        statusMsg.innerText = "";
        
        socks = [];
        for(let i=0; i<socksNeeded; i++) {
            socks.push({
                x: Math.random() * 700 + 50,
                y: Math.random() * 300 + 200, 
                color1: `hsl(${Math.random()*360}, 70%, 60%)`, 
                color2: `hsl(${Math.random()*360}, 70%, 40%)`
            });
        }
    }

    // --- ART ASSETS ---

    function drawEnvironment() {
        // Mint Wall
        ctx.fillStyle = "#e0f2f1"; 
        ctx.fillRect(0,0, canvas.width, 200);
        
        // Wood Floor
        let floorGrad = ctx.createLinearGradient(0, 200, 0, 600);
        floorGrad.addColorStop(0, "#d7ccc8"); 
        floorGrad.addColorStop(1, "#8d6e63"); 
        ctx.fillStyle = floorGrad; ctx.fillRect(0, 200, canvas.width, 400);
        
        ctx.strokeStyle = "rgba(0,0,0,0.05)"; ctx.lineWidth = 2;
        for(let i=0; i<canvas.width; i+= 80) {
            ctx.beginPath(); ctx.moveTo(i, 200); ctx.lineTo(i-150, 600); ctx.stroke();
        }

        // Door
        ctx.fillStyle = (socksCollected >= socksNeeded) ? "#fff" : "#4e342e"; 
        ctx.fillRect(door.x, door.y, door.w, door.h);
        ctx.strokeStyle = "#3e2723"; ctx.lineWidth = 6;
        ctx.strokeRect(door.x-3, door.y-3, door.w+6, door.h+6);
        ctx.fillStyle = "#212121"; ctx.fillRect(door.x+10, door.y+70, door.w-20, 50);
        
        ctx.font = "bold 16px Fredoka"; ctx.textAlign = "center"; ctx.fillStyle = "#3e2723"; 
        ctx.fillText("DOGGY DOOR", door.x + door.w/2, door.y - 10);
    }

    function drawRealSock(x, y, c1, c2, scale=1) {
        ctx.save(); ctx.translate(x, y); ctx.scale(scale, scale);
        ctx.fillStyle = c1; ctx.beginPath();
        ctx.moveTo(0, 0); ctx.lineTo(0, 20); ctx.bezierCurveTo(0, 30, 10, 30, 15, 25); 
        ctx.lineTo(25, 25); ctx.bezierCurveTo(30, 25, 30, 15, 25, 15); 
        ctx.lineTo(10, 15); ctx.lineTo(10, 0); ctx.fill();
        ctx.fillStyle = c2; ctx.beginPath();
        ctx.moveTo(25, 15); ctx.bezierCurveTo(30, 15, 30, 25, 25, 25);
        ctx.lineTo(20, 25); ctx.lineTo(20, 15); ctx.fill();
        ctx.fillStyle = c2; ctx.fillRect(0, 0, 10, 5);
        ctx.restore();
    }

    function drawDylan(x, y, dir, hasSocks, scale=1) {
        ctx.save();
        ctx.translate(x + dylan.w/2, y + dylan.h/2);
        ctx.scale(scale, scale);
        if (dir === -1) ctx.scale(-1, 1);

        // Turbo Sparks
        if (isSprinting && gameState === 'PLAYING') {
            ctx.fillStyle = `hsl(${frame * 20}, 100%, 70%)`; 
            for(let i=0; i<3; i++) {
                let sx = -50 - Math.random() * 20;
                let sy = Math.random() * 30 - 10;
                ctx.beginPath(); ctx.arc(sx, sy, 4, 0, Math.PI*2); ctx.fill();
            }
        }

        let moveBounce = dylan.isMoving ? Math.sin(frame * (isSprinting ? 0.8 : 0.4)) * 3 : 0;
        let legMove = dylan.isMoving ? Math.sin(frame * (isSprinting ? 0.8 : 0.4)) * 10 : 0;

        // === DYLAN (Black & White Bernese) ===
        // Legs (Black with White Paws)
        ctx.fillStyle = "#111"; // Black legs
        ctx.fillRect(-25 + legMove, 20, 12, 30); ctx.fillRect(15 - legMove, 20, 12, 30); 
        ctx.fillRect(-35 - legMove, 25, 12, 30); ctx.fillRect(20 + legMove, 25, 12, 30); 
        ctx.fillStyle = "white"; // White Paws
        ctx.fillRect(-25 + legMove, 45, 12, 5); ctx.fillRect(15 - legMove, 45, 12, 5);
        ctx.fillRect(-35 - legMove, 50, 12, 5); ctx.fillRect(20 + legMove, 50, 12, 5);

        // Tail (Black with White Tip)
        let tailWag = Math.sin(frame * (isSprinting ? 1.0 : 0.5)) * 20;
        ctx.strokeStyle = "#111"; ctx.lineWidth = 14; ctx.lineCap = "round";
        ctx.beginPath(); ctx.moveTo(-35, 5); ctx.quadraticCurveTo(-60, -10 + tailWag, -75, 5 + tailWag); ctx.stroke();
        ctx.strokeStyle = "white"; ctx.lineWidth = 10; // White Tip
        ctx.beginPath(); ctx.moveTo(-70, 0 + tailWag); ctx.lineTo(-76, 5 + tailWag); ctx.stroke();

        // Body (Black)
        ctx.fillStyle = "#111"; ctx.beginPath(); ctx.ellipse(0, 5 + moveBounce, 45, 30, 0, 0, Math.PI * 2); ctx.fill();
        
        // White Chest (Big Patch)
        ctx.fillStyle = "white"; 
        ctx.beginPath(); 
        ctx.moveTo(-10, 10 + moveBounce); ctx.lineTo(30, 10 + moveBounce); 
        ctx.lineTo(25, 38 + moveBounce); ctx.lineTo(-5, 38 + moveBounce); ctx.fill();

        // Head (Black)
        ctx.fillStyle = "#111"; ctx.beginPath(); ctx.arc(35, -15 + moveBounce, 24, 0, Math.PI * 2); ctx.fill();
        // Ears (Black Floppy)
        ctx.beginPath(); ctx.ellipse(28, -25 + moveBounce, 10, 18, -0.5, 0, Math.PI * 2); ctx.fill(); 

        // White Muzzle & Blaze
        ctx.fillStyle = "white"; 
        ctx.beginPath(); ctx.ellipse(35, -15 + moveBounce, 6, 18, 0, 0, Math.PI * 2); ctx.fill(); // Stripe up face
        ctx.beginPath(); ctx.ellipse(38, -8 + moveBounce, 12, 10, 0, 0, Math.PI * 2); ctx.fill(); // Muzzle

        // Face Details
        ctx.fillStyle = "black"; ctx.beginPath(); ctx.arc(42, -12 + moveBounce, 3, 0, Math.PI * 2); ctx.fill(); // Nose
        ctx.fillStyle = "white"; ctx.beginPath(); ctx.arc(36, -20 + moveBounce, 3, 0, Math.PI * 2); ctx.fill(); // Eye
        ctx.fillStyle = "black"; ctx.beginPath(); ctx.arc(37, -20 + moveBounce, 1.5, 0, Math.PI * 2); ctx.fill(); 

        if (hasSocks) {
            // Sock hanging from mouth
            drawRealSock(45, -8 + moveBounce, socks[0] ? socks[0].color1 : "#FF69B4", "white", 0.6);
        } else {
             // Pink Tongue
             ctx.fillStyle = "#ff8a80"; ctx.beginPath(); ctx.ellipse(42, -5+moveBounce, 5, 8, 0.5, 0, Math.PI*2); ctx.fill();
        }
        ctx.restore();
    }

    function drawMelissa(x, y, dir, isAngry, scale=1) {
        ctx.save();
        ctx.translate(x + melissa.w/2, y + melissa.h/2);
        ctx.scale(scale, scale);
        if (dir === -1) ctx.scale(-1, 1);

        let sway = isAngry ? 0 : Math.sin(frame * 0.1) * 2;
        let hairFlow = isAngry ? 0 : Math.sin(frame * 0.15) * 5;

        // Hair (Purple/Black)
        ctx.fillStyle = "#8A2BE2"; // Purple under
        ctx.beginPath(); ctx.moveTo(0, -50); ctx.bezierCurveTo(-50, -20, -60 + hairFlow, 20, -40 + hairFlow, 60); ctx.lineTo(15, -30); ctx.fill();
        ctx.fillStyle = "#111"; // Black top
        ctx.beginPath(); ctx.moveTo(0, -50); ctx.bezierCurveTo(-45, -20, -55 + hairFlow, 10, -35 + hairFlow, 50); ctx.lineTo(15, -30); ctx.fill();
        
        // Robe (Black with Gryffindor Red lining)
        ctx.fillStyle = "#740001"; // Gryffindor Red (Inside Cape)
        ctx.beginPath(); ctx.moveTo(5, -30); ctx.lineTo(-30, 55); ctx.lineTo(30, 55); ctx.lineTo(15, -30); ctx.fill();
        ctx.fillStyle = "#1a1a1a"; // Outer Robe
        ctx.beginPath(); ctx.moveTo(5, -30); ctx.lineTo(-20, 55); ctx.lineTo(20, 55); ctx.lineTo(15, -30); ctx.fill();
        
        // Trim
        ctx.fillStyle = "#740001"; ctx.fillRect(-15, -25, 6, 80); ctx.fillRect(15, -25, 6, 80);
        
        // Head (Spanish / Tan Skin)
        ctx.fillStyle = "#e0ac69"; // Tan skin
        ctx.beginPath(); ctx.arc(5, -35 + sway, 13, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = "black"; ctx.beginPath(); ctx.arc(10, -35 + sway, 2, 0, Math.PI*2); ctx.fill(); // Eye
        
        // Hat
        ctx.save(); ctx.translate(2, -45 + sway); ctx.rotate(-0.1);
        ctx.fillStyle = "#111"; ctx.beginPath(); ctx.ellipse(0, 0, 28, 6, 0, 0, Math.PI*2); ctx.fill(); // Brim
        ctx.beginPath(); ctx.moveTo(-18, 0); ctx.lineTo(0, -50); ctx.lineTo(18, 0); ctx.fill(); // Cone
        ctx.fillStyle = "#740001"; ctx.fillRect(-14, -8, 28, 5); // Red Band
        ctx.restore();

        // Arms
        if (isAngry) {
            ctx.strokeStyle = "#e0ac69"; ctx.lineWidth = 4;
            ctx.beginPath(); ctx.moveTo(0, -10); ctx.lineTo(-15, 10); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(10, -10); ctx.lineTo(25, 10); ctx.stroke();
        } else {
            ctx.strokeStyle = "#e0ac69"; ctx.lineWidth = 4;
            ctx.beginPath(); ctx.moveTo(10, -10); ctx.lineTo(25, 0); ctx.stroke();
            ctx.strokeStyle = "#5d4037"; ctx.lineWidth = 3;
            ctx.beginPath(); ctx.moveTo(25, 0); ctx.lineTo(45, -5); ctx.stroke();
            ctx.fillStyle = "#00ffff"; ctx.beginPath(); ctx.arc(45, -5, Math.random()*4+2, 0, Math.PI*2); ctx.fill();
        }
        ctx.restore();
    }

    function drawStartScene() {
        // Soft Modern Gradient Background
        let grad = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
        grad.addColorStop(0, "#a8c0ff"); // Light Blue
        grad.addColorStop(1, "#3f2b96"); // Deep Purple
        ctx.fillStyle = grad;
        ctx.fillRect(0,0, canvas.width, canvas.height);

        // Soft white overlay circle for focus
        ctx.fillStyle = "rgba(255,255,255,0.1)";
        ctx.beginPath(); ctx.arc(canvas.width/2, canvas.height/2, 300, 0, Math.PI*2); ctx.fill();

        // Draw Big Dylan on Right
        // We simulate a frame count for animation
        frame++;
        drawDylan(550, 350, -1, true, 1.5); // 1.5x scale
        
        // Draw Melissa on Left
        drawMelissa(150, 320, 1, false, 1.5); // 1.5x scale
    }

    // --- Update Loop ---
    function update() {
        if (gameState !== 'PLAYING') return;
        frame++;

        let elapsed = Date.now() - startTime;
        let remainingHeadStart = Math.ceil((headStartDuration - elapsed) / 1000);

        if (remainingHeadStart > 0) {
            statusMsg.innerText = `Melissa enters in: ${remainingHeadStart}`;
            statusMsg.style.color = "white";
        } else if (remainingHeadStart <= 0 && melissa.x < -50) {
             statusMsg.innerText = "MELISSA IS HERE! RUN!"; statusMsg.style.color = "#FF1493"; 
        } else if (socksCollected < socksNeeded) {
             statusMsg.innerText = ""; 
        }

        dylan.isMoving = false;
        let currentSpeed = dylan.baseSpeed;
        
        if (moveStartTime > 0 && (Date.now() - moveStartTime > 2000)) {
            currentSpeed = 12; isSprinting = true;
        } else {
            isSprinting = false;
        }

        if (keys['ArrowUp'] && dylan.y > 180) { dylan.y -= currentSpeed; dylan.isMoving = true; }
        if (keys['ArrowDown'] && dylan.y + dylan.h < 600) { dylan.y += currentSpeed; dylan.isMoving = true; }
        if (keys['ArrowLeft'] && dylan.x > 0) { dylan.x -= currentSpeed; dylan.dirX = -1; dylan.isMoving = true; }
        if (keys['ArrowRight'] && dylan.x + dylan.w < 800) { dylan.x += currentSpeed; dylan.dirX = 1; dylan.isMoving = true; }

        if (remainingHeadStart <= 0) {
            let dx = dylan.x - melissa.x;
            let dy = dylan.y - melissa.y;
            let dist = Math.sqrt(dx*dx + dy*dy);
            if (dist > 10) {
                melissa.x += (dx/dist) * melissa.speed;
                melissa.y += (dy/dist) * melissa.speed;
                melissa.dirX = dx > 0 ? 1 : -1;
            }
            if (dist < 40) { gameState = 'LOST'; endGame(); }
        }

        for (let i = socks.length - 1; i >= 0; i--) {
            let s = socks[i];
            if (dylan.x < s.x + 30 && dylan.x + dylan.w > s.x && 
                dylan.y < s.y + 30 && dylan.y + dylan.h > s.y) {
                socks.splice(i, 1);
                socksCollected++;
                scoreSpan.innerText = socksCollected;
                if (socksCollected >= socksNeeded) {
                    statusMsg.innerText = "RUN TO THE DOGGY DOOR!";
                    statusMsg.style.color = "#00FF00";
                }
            }
        }

        if (socksCollected >= socksNeeded) {
            if (dylan.y < door.y + door.h && dylan.x > door.x - 20 && dylan.x < door.x + door.w + 20) {
                gameState = 'WON'; endGame();
            }
        }
    }

    function endGame() {
        endScreenControls.style.display = 'flex'; 
        mobileControls.style.display = 'none'; 
        statusMsg.innerText = "";
    }

    function draw() {
        if(gameState === 'START') {
            drawStartScene();
            requestAnimationFrame(draw); 
            return;
        }

        ctx.clearRect(0,0, canvas.width, canvas.height);

        if (gameState === 'WON') { drawWinScene(); return; }
        if (gameState === 'LOST') { drawLoseScene(); return; }

        drawEnvironment();
        socks.forEach(s => drawRealSock(s.x, s.y, s.color1, s.color2));
        drawDylan(dylan.x, dylan.y, dylan.dirX, socksCollected > 0);
        
        let elapsed = Date.now() - startTime;
        if (elapsed > headStartDuration || melissa.x > -100) {
             drawMelissa(melissa.x, melissa.y, melissa.dirX, false);
        }
    }

    function drawTree(x, y) {
        ctx.fillStyle = "#5d4037"; ctx.fillRect(x, y, 20, 60);
        ctx.fillStyle = "#388e3c"; 
        ctx.beginPath(); ctx.arc(x+10, y-10, 30, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(x-10, y+10, 25, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(x+30, y+5, 25, 0, Math.PI*2); ctx.fill();
    }
    function drawShed(x, y) {
        ctx.fillStyle = "#f5f5f5"; ctx.fillRect(x, y, 100, 80);
        ctx.fillStyle = "#616161"; 
        ctx.beginPath(); ctx.moveTo(x-10, y); ctx.lineTo(x+50, y-40); ctx.lineTo(x+110, y); ctx.fill();
        ctx.strokeStyle = "#bdbdbd"; ctx.lineWidth=2; ctx.strokeRect(x+30, y+20, 40, 60);
        ctx.fillStyle = "#757575"; ctx.beginPath(); ctx.arc(x+65, y+50, 3, 0, Math.PI*2); ctx.fill();
    }

    function drawWinScene() {
        frame++;
        let grad = ctx.createLinearGradient(0, 0, 0, 600);
        grad.addColorStop(0, "#a8c0ff"); grad.addColorStop(1, "#3f2b96"); 
        ctx.fillStyle = grad; ctx.fillRect(0,0, canvas.width, canvas.height);
        
        ctx.fillStyle = "#66bb6a"; ctx.fillRect(0, 300, canvas.width, 300);
        drawShed(50, 350); drawTree(650, 350); drawTree(720, 380); drawTree(580, 400);

        let runX = 400 + Math.sin(frame * 0.05) * 300;
        let runY = 400 + Math.cos(frame * 0.07) * 50; 
        let runDir = Math.cos(frame * 0.05) > 0 ? 1 : -1;
        drawDylan(runX, runY, runDir, true);

        ctx.font = "bold 50px Fredoka"; ctx.textAlign = "center"; 
        ctx.fillStyle = "white"; ctx.shadowColor="rgba(0,0,0,0.3)"; ctx.shadowBlur=10;
        ctx.fillText("FREEDOM!", 400, 100); ctx.shadowBlur=0;
        
        ctx.font = "24px Fredoka"; 
        ctx.fillText("Dylan is free in the garden!", 400, 150);
    }

    function drawLoseScene() {
        let grad = ctx.createLinearGradient(0, 0, 0, 600);
        grad.addColorStop(0, "#300030"); grad.addColorStop(1, "#000000"); 
        ctx.fillStyle = grad; ctx.fillRect(0,0, canvas.width, canvas.height);

        drawMelissa(300, 300, 1, true); 
        drawRealSock(360, 350, "red", "white"); drawRealSock(370, 340, "blue", "white"); drawRealSock(380, 355, "green", "white");
        drawDylan(500, 320, -1, false);

        ctx.font = "bold 50px Fredoka"; ctx.textAlign = "center"; 
        ctx.fillStyle = "#ff5252"; ctx.shadowColor="rgba(0,0,0,0.5)"; ctx.shadowBlur=10;
        ctx.fillText("CAUGHT!", 400, 150); ctx.shadowBlur=0;
        
        ctx.font = "24px Fredoka"; ctx.fillStyle = "white";
        ctx.fillText('"No Dylan, these socks are for Dobby!"', 400, 220);
    }

    function loop() {
        update();
        draw();
        if(gameState === 'PLAYING' || gameState === 'WON' || gameState === 'LOST') {
            requestAnimationFrame(loop);
        }
    }
    
    // Start animation immediately for the menu
    draw();
};
</script>
</body>
</html>
